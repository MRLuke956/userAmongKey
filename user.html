<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!--
    PolÃ­tica de SeguranÃ§a de ConteÃºdo (CSP)
    - default-src 'self': Por padrÃ£o, permite conteÃºdo apenas do mesmo domÃ­nio.
    - script-src 'self': Permite scripts apenas do mesmo domÃ­nio (NÃƒO inline).
    - style-src 'self' https://fonts.googleapis.com 'unsafe-inline': Permite estilos do mesmo domÃ­nio,
      Google Fonts e estilos inline (necessÃ¡rio pelos estilos no <head>).
      Idealmente, todos os estilos estariam em um arquivo .css separado para remover 'unsafe-inline'.
    - font-src 'self' https://fonts.gstatic.com: Permite fontes do mesmo domÃ­nio e Google Fonts.
    - img-src 'self' https://i.imgur.com data:: Permite imagens do mesmo domÃ­nio, i.imgur.com e data URIs.
      Se quiser usar outra fonte de imagem (ex: i.ytimg.com), adicione-a aqui.
      Ex: img-src 'self' https://i.imgur.com https://i.ytimg.com data:;
    - connect-src 'self' https://keygenx-ce8h.onrender.com: Permite conexÃµes (fetch)
      para o mesmo domÃ­nio e para a API de chaves.
    - object-src 'none': NÃ£o permite plugins como Flash.
    - frame-ancestors 'none': Impede que a pÃ¡gina seja embutida em iframes de outros sites (ajuda contra clickjacking).
      Este aviso sobre 'frame-ancestors' em meta tags pode ser ignorado ou a diretiva removida da meta tag
      e configurada via cabeÃ§alho HTTP no servidor, se possÃ­vel.
  -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self';
    style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' https://i.imgur.com data:;
    connect-src 'self' https://keygenx-ce8h.onrender.com;
    object-src 'none';
    frame-ancestors 'none';
  ">
  <title>Painel de Chaves - Among Us</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background-color: #080A10; /* Azul escuro do espaÃ§o profundo */
      color: #E0E0E0; /* Cinza claro para texto geral */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      /* Imagem de fundo original do seu cÃ³digo a.txt */
      background-image: url('https://i.imgur.com/3ZQ3ZQ3.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding: 20px;
      box-sizing: border-box;
    }

    .container {
      background-color: rgba(10, 20, 40, 0.9);
      padding: 30px 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 480px;
      width: 100%;
      border: 2px solid #00FFFF; /* Borda Ciano Neon */
      box-shadow: 0 0 20px #00FFFF, 0 0 8px #00FFFF inset;
    }

    h1 {
      color: #FF4136; /* Vermelho "EmergÃªncia" */
      margin-bottom: 20px;
      font-size: 2em;
      text-transform: uppercase;
      text-shadow: 0 0 8px #FF4136, 0 0 12px #FF4136;
    }

    p {
      font-size: 0.95em;
      line-height: 1.6;
      color: #A0D2DB;
      margin-bottom: 25px;
    }

    .button-group {
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }

    button {
      background-color: #FFC600; /* Amarelo "Task" */
      border: none;
      color: #1A1A1A;
      padding: 12px 25px;
      font-size: 1em;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      text-transform: uppercase;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      border-bottom: 3px solid #D4A300;
      box-shadow: 0 0 8px rgba(255, 198, 0, 0.4);
    }

    button:hover:not(:disabled) {
      background-color: #FFD700;
      transform: translateY(-2px);
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
    }

    button:active:not(:disabled) {
      transform: translateY(1px);
      border-bottom-width: 2px;
    }

    button:disabled {
      background-color: #777777;
      color: #AAAAAA;
      cursor: not-allowed;
      opacity: 0.7;
      border-bottom-color: #555555;
      box-shadow: none;
    }

    #keyDisplay {
      margin-top: 25px;
      font-size: 1.3em;
      color: #39FF14; /* Verde Neon */
      background-color: #05080F;
      padding: 12px 15px;
      border-radius: 5px;
      border: 1px solid #39FF14;
      min-height: 1.5em;
      word-break: break-all;
      box-shadow: 0 0 8px #39FF14 inset;
      letter-spacing: 1px;
    }

    #message {
      margin-top: 15px;
      font-size: 0.9em;
      min-height: 1.2em;
      padding: 5px;
    }

    .message-error { color: #FF4136; font-weight: bold; }
    .message-success { color: #39FF14; font-weight: bold; }
    .message-loading { color: #FFC600; font-weight: bold; }
    .message-info { color: #A0D2DB; }

    ul#minhasChaves {
      list-style: none;
      padding-left: 0;
      margin-top: 25px;
      text-align: left;
      color: #f39c12; /* Laranja */
      max-height: 150px;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 10px;
      border: 1px dashed #f39c12;
      display: none; /* Escondido por padrÃ£o */
    }

    ul#minhasChaves li {
      background-color: rgba(255, 255, 255, 0.07);
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
      color: #FFD700; /* Amarelo claro */
      word-break: break-all;
    }
    ul#minhasChaves li:last-child {
      margin-bottom: 0;
    }

    ul#minhasChaves::-webkit-scrollbar { width: 8px; }
    ul#minhasChaves::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
    ul#minhasChaves::-webkit-scrollbar-thumb { background-color: #f39c12; border-radius: 4px; }
    ul#minhasChaves::-webkit-scrollbar-thumb:hover { background-color: #e68a00; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Painel de Chaves</h1>
    <p>Tripulante, o sistema da nave requer autenticaÃ§Ã£o. Gere uma nova chave ou veja suas chaves.</p>

    <div class="button-group">
      <button id="generateKeyButton">ðŸŽ® Gerar Nova Chave</button>
      <button id="viewKeysButton">ðŸ“œ Ver Minhas Chaves</button>
    </div>

    <div id="keyDisplay"></div>
    <div id="message"></div>
    <ul id="minhasChaves"></ul>
  </div>

  <script>
    // Selecionando os elementos do DOM
    const generateKeyButton = document.getElementById('generateKeyButton');
    const viewKeysButton = document.getElementById('viewKeysButton');
    const keyDisplay = document.getElementById('keyDisplay');
    const message = document.getElementById('message');
    const minhasChavesList = document.getElementById('minhasChaves');

    const originalGenerateButtonText = generateKeyButton.textContent;
    const originalViewKeysButtonText = viewKeysButton.textContent;

    // FunÃ§Ã£o auxiliar para mostrar mensagens e seus tipos
    function showMessage(text, type = 'info') {
      message.textContent = text;
      message.className = `message-${type}`; // Adiciona classe para estilizaÃ§Ã£o especÃ­fica
    }

    // FunÃ§Ã£o centralizada para chamadas fetch
    async function fetchData(url, buttonToManage, loadingText) {
      if (buttonToManage) {
        buttonToManage.disabled = true;
        buttonToManage.textContent = loadingText;
      }
      // Limpa keyDisplay e message ao iniciar uma nova chamada
      keyDisplay.textContent = '';
      showMessage('Comunicando com a central...', 'loading');
      minhasChavesList.style.display = 'none'; // Esconde a lista durante o carregamento

      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (e) {
            // Se o corpo do erro nÃ£o for JSON ou estiver vazio
            errorData = { message: response.statusText || `Erro HTTP ${response.status}` };
          }
          throw new Error(`Falha na resposta do servidor (${response.status}): ${errorData.message}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Erro na chamada API:', error);
        showMessage(`ERRO: ${error.message}. Verifique a conexÃ£o ou tente mais tarde.`, 'error');
        keyDisplay.textContent = '--- FALHA NA COMUNICAÃ‡ÃƒO ---';
        return null; // Retorna null para indicar falha
      } finally {
        // A reabilitaÃ§Ã£o dos botÃµes serÃ¡ feita pelas funÃ§Ãµes especÃ­ficas
      }
    }

    // FunÃ§Ã£o para gerar chave
    async function generateAndDisplayKey() {
      const data = await fetchData('https://keygenx-ce8h.onrender.com/generate_key', generateKeyButton, 'GERANDO...');

      if (data) { // Verifica se data nÃ£o Ã© null (ou seja, nÃ£o houve erro no fetch)
        if (data.status === 'success' && data.keys?.length > 0) {
          keyDisplay.textContent = `ðŸ”‘ Nova Chave: ${data.keys[0]}`;
          showMessage('Chave de acesso gerada pela central!', 'success');
          // Opcional: atualizar e mostrar a lista de chaves automaticamente
          // await displayUserKeys(false);
        } else {
          keyDisplay.textContent = '--- FALHA NA GERAÃ‡ÃƒO ---';
          showMessage(data.message || 'Resposta inesperada do servidor ao gerar chave.', 'error');
        }
      }
      // Reabilitar o botÃ£o de gerar chave
      generateKeyButton.disabled = false;
      generateKeyButton.textContent = originalGenerateButtonText;
    }

    // FunÃ§Ã£o para ver/mostrar as chaves do usuÃ¡rio
    async function displayUserKeys(manageButtonState = true) {
      const data = await fetchData('https://keygenx-ce8h.onrender.com/user_keys', manageButtonState ? viewKeysButton : null, 'BUSCANDO SUAS CHAVES...');

      minhasChavesList.innerHTML = ''; // Limpa a lista antes de popular

      if (data) {
        if (data.status === 'success' && data.keys) {
          if (data.keys.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'Nenhuma chave encontrada para este usuÃ¡rio.';
            minhasChavesList.appendChild(li);
            showMessage('VocÃª ainda nÃ£o possui chaves.', 'info');
          } else {
            data.keys.forEach(key => {
              const li = document.createElement('li');
              li.textContent = key; // Seguro contra XSS
              minhasChavesList.appendChild(li);
            });
            showMessage(`${data.keys.length} chave(s) carregada(s) da central.`, 'success');
          }
          minhasChavesList.style.display = 'block'; // Mostra a lista
        } else {
          const li = document.createElement('li');
          li.textContent = 'Erro ao buscar chaves.';
          minhasChavesList.appendChild(li);
          minhasChavesList.style.display = 'block';
          showMessage(data.message || 'Resposta inesperada do servidor ao buscar chaves.', 'error');
        }
      } else {
        // Se data for null, a fetchData jÃ¡ mostrou uma mensagem de erro de conexÃ£o.
        // Podemos adicionar um item Ã  lista indicando a falha.
        const li = document.createElement('li');
        li.textContent = 'NÃ£o foi possÃ­vel carregar as chaves devido a um erro.';
        minhasChavesList.appendChild(li);
        minhasChavesList.style.display = 'block';
      }

      if (manageButtonState) {
        viewKeysButton.disabled = false;
        viewKeysButton.textContent = originalViewKeysButtonText;
      }
    }

    // Adicionando os event listeners aos botÃµes
    generateKeyButton.addEventListener('click', generateAndDisplayKey);
    viewKeysButton.addEventListener('click', () => displayUserKeys(true));

  </script>
</body>
</html>
